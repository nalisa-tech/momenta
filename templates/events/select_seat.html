{% extends "base.html" %}

{% block title %}Select Tickets - {{ event.title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
                <i class="fas fa-ticket-alt text-white text-2xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Select Your Tickets</h1>
            <p class="text-gray-600">{{ event.title }} • {{ event.date|date:"F j, Y" }} • {{ event.location }}</p>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Event Info -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
                    Event Details
                </h3>
                
                {% if event.primary_image %}
                    <img src="{{ event.primary_image.url }}" alt="{{ event.title }}" class="w-full h-48 object-cover rounded-lg mb-4">
                {% else %}
                    <div class="w-full h-48 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg flex items-center justify-center mb-4">
                        <i class="fas fa-calendar-alt text-white text-6xl"></i>
                    </div>
                {% endif %}
                
                <div class="space-y-3">
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-calendar-alt text-blue-600 mr-3 w-5"></i>
                        <span>{{ event.date|date:"l, F j, Y" }}</span>
                    </div>
                    {% if event.time %}
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-clock text-blue-600 mr-3 w-5"></i>
                        <span>{{ event.time|time:"g:i A" }}</span>
                    </div>
                    {% endif %}
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-map-marker-alt text-blue-600 mr-3 w-5"></i>
                        <span>{{ event.location }}</span>
                    </div>
                    <div class="flex items-center text-gray-700">
                        <i class="fas fa-user text-blue-600 mr-3 w-5"></i>
                        <span>{{ event.organizer_name }}</span>
                    </div>
                </div>
            </div>

            <!-- Ticket Selection -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fas fa-ticket-alt text-blue-600 mr-2"></i>
                    Choose Your Tickets
                </h3>

                {% if event.vip_seats_left <= 0 and event.gold_seats_left <= 0 and event.standard_seats_left <= 0 %}
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                        <h4 class="text-xl font-bold text-red-600 mb-2">Event Sold Out</h4>
                        <p class="text-gray-600">Sorry, all tickets for this event have been sold.</p>
                        <a href="{% url 'events:home' %}" class="inline-block mt-4 bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition">
                            Browse Other Events
                        </a>
                    </div>
                {% else %}
                    <div class="space-y-4">
                        <!-- VIP Tickets -->
                        {% if event.vip_seats_left > 0 %}
                        <div class="ticket-option border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-yellow-400 hover:shadow-lg transition-all duration-300" 
                             onclick="selectTicket('vip', 1500, {{ event.vip_seats_left }})">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-crown text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">VIP Front Row</h4>
                                        <p class="text-gray-600 text-sm">Premium seating with exclusive perks</p>
                                        <p class="text-sm text-green-600">{{ event.vip_seats_left }} seats available</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-yellow-600">K1,500</div>
                                    <div class="text-sm text-gray-500">per ticket</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Gold Tickets -->
                        {% if event.gold_seats_left > 0 %}
                        <div class="ticket-option border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-orange-400 hover:shadow-lg transition-all duration-300" 
                             onclick="selectTicket('gold', 850, {{ event.gold_seats_left }})">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-star text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Gold Section</h4>
                                        <p class="text-gray-600 text-sm">Great view with comfort</p>
                                        <p class="text-sm text-green-600">{{ event.gold_seats_left }} seats available</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-orange-600">K850</div>
                                    <div class="text-sm text-gray-500">per ticket</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Standard Tickets -->
                        {% if event.standard_seats_left > 0 %}
                        <div class="ticket-option border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-blue-400 hover:shadow-lg transition-all duration-300" 
                             onclick="selectTicket('standard', 450, {{ event.standard_seats_left }})">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-ticket-alt text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900">Standard</h4>
                                        <p class="text-gray-600 text-sm">Affordable access to the event</p>
                                        <p class="text-sm text-green-600">{{ event.standard_seats_left }} seats available</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-blue-600">K450</div>
                                    <div class="text-sm text-gray-500">per ticket</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Quantity Selection (Hidden initially) -->
                    <div id="quantity-section" class="mt-6 p-4 bg-gray-50 rounded-xl" style="display: none;">
                        <label class="block font-semibold mb-3">Number of Tickets:</label>
                        <div class="flex items-center gap-4">
                            <button type="button" onclick="changeQuantity(-1)" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-300 transition">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="ticket-quantity" min="1" value="1" class="w-20 text-center border rounded-lg p-2 font-semibold text-lg">
                            <button type="button" onclick="changeQuantity(1)" class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center hover:bg-gray-300 transition">
                                <i class="fas fa-plus"></i>
                            </button>
                            <div class="ml-auto">
                                <div class="text-sm text-gray-600">Total:</div>
                                <div id="total-price" class="text-xl font-bold text-green-600">K0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Proceed Button (Hidden initially) -->
                    <div id="proceed-section" class="mt-6" style="display: none;">
                        <form method="post" action="{% url 'events:payment_page' event.id %}">
                            {% csrf_token %}
                            <input type="hidden" id="selected-ticket-type" name="ticket_type" value="">
                            <input type="hidden" id="selected-tickets" name="tickets" value="1">
                            
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl py-4 px-8 text-lg font-semibold hover:from-blue-700 hover:to-blue-800 focus:ring-4 focus:ring-blue-200 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-credit-card mr-3"></i>
                                Proceed to Payment
                            </button>
                        </form>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.ticket-option.selected {
    border-color: #3B82F6 !important;
    background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
}

.ticket-option:hover {
    transform: translateY(-2px);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-down {
    animation: slideDown 0.3s ease-out;
}
</style>

<script>
let selectedTicketType = '';
let ticketPrice = 0;
let maxTickets = 0;

function selectTicket(type, price, available) {
    // Remove previous selection
    document.querySelectorAll('.ticket-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selection to clicked option
    event.currentTarget.classList.add('selected');
    
    // Store selection
    selectedTicketType = type;
    ticketPrice = price;
    maxTickets = available;
    
    // Update hidden form fields
    document.getElementById('selected-ticket-type').value = type;
    
    // Show quantity section
    const quantitySection = document.getElementById('quantity-section');
    const proceedSection = document.getElementById('proceed-section');
    
    quantitySection.style.display = 'block';
    proceedSection.style.display = 'block';
    
    quantitySection.classList.add('slide-down');
    proceedSection.classList.add('slide-down');
    
    // Reset quantity to 1
    const quantityInput = document.getElementById('ticket-quantity');
    quantityInput.value = 1;
    quantityInput.max = available;
    
    // Update total price
    updateTotalPrice();
    
    // Scroll to quantity section
    quantitySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function changeQuantity(delta) {
    const quantityInput = document.getElementById('ticket-quantity');
    let newValue = parseInt(quantityInput.value) + delta;
    
    if (newValue < 1) newValue = 1;
    if (newValue > maxTickets) newValue = maxTickets;
    
    quantityInput.value = newValue;
    document.getElementById('selected-tickets').value = newValue;
    
    updateTotalPrice();
}

function updateTotalPrice() {
    const quantity = parseInt(document.getElementById('ticket-quantity').value);
    const total = ticketPrice * quantity;
    
    document.getElementById('total-price').textContent = `K${total.toLocaleString()}`;
    document.getElementById('selected-tickets').value = quantity;
}

// Update total when quantity input changes directly
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('ticket-quantity');
    
    quantityInput.addEventListener('input', function() {
        let value = parseInt(this.value);
        
        if (isNaN(value) || value < 1) {
            value = 1;
            this.value = 1;
        }
        
        if (value > maxTickets) {
            value = maxTickets;
            this.value = maxTickets;
        }
        
        document.getElementById('selected-tickets').value = value;
        updateTotalPrice();
    });
});
</script>
{% endblock %}
